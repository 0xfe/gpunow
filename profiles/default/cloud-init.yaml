#cloud-config
package_update: true
packages:
  - git
  - build-essential
  - python3
  - python3-dev
  - zsh

users:
  - name: mo
    gecos: mo
    shell: /bin/zsh
    groups: [sudo]
    sudo: ["ALL=(ALL) NOPASSWD:ALL"]
    lock_passwd: true

write_files:
  - path: /tmp/gpunow-setup.sh
    owner: root:root
    permissions: "0755"
    content: |
      {{SETUP_SH}}
  - path: /tmp/gpunow-zshrc
    owner: root:root
    permissions: "0644"
    content: |
      {{ZSHRC}}
  - path: /usr/local/bin/gpunow-ready-server.py
    owner: root:root
    permissions: "0755"
    content: |
      #!/usr/bin/env python3
      import http.server
      import socketserver

      STATE_FILE = "/var/lib/gpunow/readiness"
      ALLOWED = {"ready", "running", "error"}

      class Handler(http.server.BaseHTTPRequestHandler):
          def do_GET(self):
              state = "error"
              try:
                  with open(STATE_FILE, "r", encoding="utf-8") as handle:
                      value = handle.read().strip().lower()
                      if value in ALLOWED:
                          state = value
              except Exception:
                  state = "error"
              body = state.encode("utf-8")
              self.send_response(200)
              self.send_header("Content-Type", "text/plain; charset=utf-8")
              self.send_header("Content-Length", str(len(body)))
              self.end_headers()
              self.wfile.write(body)

          def log_message(self, _format, *_args):
              return

      class Server(socketserver.ThreadingMixIn, http.server.HTTPServer):
          daemon_threads = True

      with Server(("0.0.0.0", 34223), Handler) as server:
          server.serve_forever()
  - path: /usr/local/bin/gpunow-provision.sh
    owner: root:root
    permissions: "0755"
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      state_dir="/var/lib/gpunow"
      state_file="${state_dir}/readiness"
      mkdir -p "${state_dir}"
      echo "running" > "${state_file}"

      on_error() {
        echo "error" > "${state_file}"
      }
      trap on_error ERR

      install -m 0755 /tmp/gpunow-setup.sh /home/mo/setup.sh
      install -m 0644 /tmp/gpunow-zshrc /home/mo/.zshrc
      chown mo:mo /home/mo/setup.sh /home/mo/.zshrc
      rm -f /tmp/gpunow-setup.sh /tmp/gpunow-zshrc

      command -v zsh >/dev/null 2>&1 || (echo "zsh is required but not installed" >&2; exit 1)
      su - mo -c "/home/mo/setup.sh"

      ufw allow 22/tcp
      ufw allow 34223/tcp
      ufw --force enable

      echo "ready" > "${state_file}"
      trap - ERR
  - path: /etc/systemd/system/gpunow-ready.service
    owner: root:root
    permissions: "0644"
    content: |
      [Unit]
      Description=gpunow readiness sentinel server
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=simple
      ExecStart=/usr/bin/python3 /usr/local/bin/gpunow-ready-server.py
      Restart=always
      RestartSec=1
      NoNewPrivileges=yes
      PrivateTmp=yes
      ProtectSystem=full
      ProtectHome=yes

      [Install]
      WantedBy=multi-user.target

runcmd:
  - [bash, -lc, "systemctl daemon-reload"]
  - [bash, -lc, "systemctl enable --now gpunow-ready.service"]
  - [bash, -lc, "/usr/local/bin/gpunow-provision.sh"]
